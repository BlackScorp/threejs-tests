<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8>
    <title>Test</title>
    <style>
        body {
            margin: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 0;
        }

        canvas {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: absolute;
            left: 0;
            top: 0;
        }
        .actions{
            text-align: center;

            position: absolute;
            width: 100%;
            z-index: 2;
        }
        .actions button{
            font-size: 2em;
        }
        .viewport{
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            position: absolute;
            left: 0;
            top: 0;

        }
    </style>
</head>
<body>
<div class="actions">
    <button class="idle" type="button">Idle</button>
    <button class="attack" type="button">Attack</button>
    <button class="get_hit" type="button">Get hit</button>
    <button class="fall" type="button">Fall</button>
</div>

<div class="viewport">

</div>
<script src="three.min.js"></script>
<script>
    var THREEx	= THREEx 		|| {};
    THREEx.WindowResize	= function(renderer, camera){
        var callback	= function(){
            // notify the renderer of the size change
            renderer.setSize( window.innerWidth, window.innerHeight );
            // update the camera
            camera.aspect	= window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        };
        // bind the resize event
        window.addEventListener('resize', callback, false);
        // return .stop() the function to stop watching window resize
        return {
            /**
             * Stop watching window resize
             */
            stop	: function(){
                window.removeEventListener('resize', callback);
            }
        };
    };
    var width = window.innerWidth;
    var height = window.innerHeight;
    var scene = new THREE.Scene();
    var clock = new THREE.Clock();
    var camera = new THREE.OrthographicCamera(window.innerWidth / -2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / -2, 1, 1000);
    //camera = new THREE.PerspectiveCamera( 40, width / height, 1, 100 );
    var renderer = new THREE.WebGLRenderer({alpha: true});
    var light = new THREE.AmbientLight(0xffffff, 1.5); // soft white light
    var loader = new THREE.JSONLoader();

    document.querySelector('.viewport').appendChild(renderer.domElement);
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.position.set(0, 200, 0);
    scene.add(camera);
    scene.add(light);


    var animation;
    var mesh;
    var actions = {};
    var mixer = [];
    var files = [
        'gladiator3.1.json',
        'gladiator3.1-shield.json',
        'gladiator3.1-sword.json',
        'gladiator3.1-armor.json',
        'gladiator3.1-pants.json',
        'gladiator3.1-helmet.json',
    ];
    var loaded = 0;
    for (var i = 0, il = files.length; i < il; i++) {
        var current = files[i];
        loader.load(current, function (geometry, materials) {

            materials.forEach(function (material) {

                material.skinning = true;
                material.opacity = 1;
                material.transparent = true;
                material.alphaTest = 0.8;

            });
            var material = new THREE.MeshFaceMaterial(materials);


            // create a mesh
            mesh = new THREE.SkinnedMesh(
                    geometry,
                    material
            );
            mesh.scale.z = mesh.scale.y = mesh.scale.x = 60;

            var localmixer = new THREE.AnimationMixer(mesh);
            for(var i=0,il = geometry.animations.length;i<il;i++){
                var current = geometry.animations[i];
                if(actions[current.name] == undefined){
                    actions[current.name] = [];
                }
                var clipaction = localmixer.clipAction(current);

                actions[current.name].push(clipaction);
            }




            mixer.push(localmixer);


            scene.add(mesh);
            ++loaded;

            if(loaded == files.length){
                playAnimation('idle',0);
            }

        });
    }

    var runningAnimation = '';
    function stopAnimation(animationName){

        var animation = actions[animationName];
        if(animation == undefined){
            return;
        }
        for(var i=0,il=animation.length;i<il;i++){
            var animationObject = animation[i];
            if(animationObject.isRunning()){
                animationObject.stop();
            }



        }
    }

    function playAnimation(animationName,loop){

        stopAnimation(runningAnimation);
        var animation = actions[animationName];
        runningAnimation = animationName;
        for(var i=0,il=animation.length;i<il;i++){
            var animationObject = animation[i];
            if(animationObject.isRunning()){
                animationObject.stop();
            }
            if(loop > 0){
                animationObject.setLoop(loop);
            }

            animationObject.play();
        }
    }
    render();
    function  handle(e){
        var button = e.target;
        playAnimation(button.className,1);
    }
    var actionButtons = document.querySelector('.actions');
    actionButtons.addEventListener( 'click', handle, false )
    actionButtons.addEventListener( 'touchstart', handle, false );




    THREEx.WindowResize(renderer, camera);

    function render() {
        //animation.update(.01);
        renderer.render(scene, camera);
        var delta = clock.getDelta();
        var theta = clock.getElapsedTime();

        if (mixer) {
            for (var i = 0, il = mixer.length; i < il; i++) {
                var current = mixer[i];
                current.update(delta);
            }
        }

        requestAnimationFrame(render);
    }

</script>
</body>
</html>